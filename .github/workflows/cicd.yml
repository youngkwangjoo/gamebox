name: CI/CD Workflow (Blue-Green Deploy)

on:
  push:
    branches:
      - dev  # âœ… Dev ë¸Œëžœì¹˜ Push ì‹œ ì‹¤í–‰

jobs:
  # 1ï¸âƒ£ ê°œë°œ ì„œë²„ ë°°í¬ (gamebox_dev)
  deploy-dev:
    runs-on: self-hosted  # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì„œë²„ì—ì„œ ì‹¤í–‰

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        poetry install

    - name: Deploy to Development Server
      env:
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p 22 gamebox@172.30.1.37 <<EOF
          cd gamebox_dev/
          git pull origin dev
          poetry install
          poetry run python manage.py migrate
          sudo systemctl daemon-reload  # ì„œë¹„ìŠ¤ ê°±ì‹ 
          sudo systemctl restart gamebox_dev  # ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
        EOF

  # # 2ï¸âƒ£ Dev â†’ Main PR ìžë™ ìƒì„±
  # create-pr:
  #   needs: deploy-dev  # âœ… ê°œë°œ ì„œë²„ ë°°í¬ê°€ ëë‚œ í›„ ì‹¤í–‰
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v3

  #     - name: Create Pull Request
  #       uses: peter-evans/create-pull-request@v5
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         branch: dev
  #         base: main
  #         title: "ðŸš€ Dev â†’ Main ë°°í¬ PR"
  #         body: "ê°œë°œ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìš´ì˜ ì„œë²„ ë°°í¬ë¥¼ ìœ„í•´ ë¦¬ë·°í•´ì£¼ì„¸ìš”!"

