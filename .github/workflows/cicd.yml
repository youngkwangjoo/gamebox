name: CI/CD Workflow (Blue-Green Deploy)

on:
  push:
    branches:
      - dev  # ✅ Dev 브랜치 Push 시 실행

jobs:
  # 1️⃣ 개발 서버 배포 (gamebox_dev)
  deploy-dev:
    runs-on: self-hosted  # 내부 네트워크 서버에서 실행

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        poetry install

    - name: Deploy to Development Server
      env:
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p 22 gamebox@172.30.1.37 <<EOF
          cd gamebox_dev/
          git pull origin dev
          poetry install
          poetry run python manage.py migrate
          sudo systemctl daemon-reload  # 서비스 갱신
          sudo systemctl restart gamebox_dev  # 실행 중인 서비스 재시작
        EOF

  # # 2️⃣ Dev → Main PR 자동 생성
  # create-pr:
  #   needs: deploy-dev  # ✅ 개발 서버 배포가 끝난 후 실행
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v3

  #     - name: Create Pull Request
  #       uses: peter-evans/create-pull-request@v5
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         branch: dev
  #         base: main
  #         title: "🚀 Dev → Main 배포 PR"
  #         body: "개발 테스트가 완료되었습니다. 운영 서버 배포를 위해 리뷰해주세요!"

