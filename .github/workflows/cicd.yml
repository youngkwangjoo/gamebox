name: CI/CD Workflow

on:
  push:
    branches:
      - main

jobs:
  # 1. Build and Test Job
  build-and-test:
    runs-on: self-hosted  # 변경: 내부 네트워크에 배치된 러너 사용

    steps:
    # 1.1 리포지토리 클론
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 1.3 Poetry 설치
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    # 1.4 의존성 설치
    - name: Install dependencies
      run: |
        poetry install

  # 2. Deploy Job
  deploy:
    needs: build-and-test
    runs-on: self-hosted  # 변경: 내부 네트워크에 배치된 러너 사용

    steps:
    # 2.1 리포지토리 클론
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2.2 SSH 배포
    - name: Deploy to Internal Server
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        # SSH 키 설정
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        # 서버에 접속하여 배포 스크립트 실행
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p 22 gamebox@172.30.1.37 <<EOF
          cd /gamebox
          git pull origin main
          poetry install
          systemctl restart gamebox
        EOF
